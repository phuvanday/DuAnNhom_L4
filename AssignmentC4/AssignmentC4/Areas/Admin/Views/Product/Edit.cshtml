@model AssignmentC4.Models.Product
@{
    ViewData["Title"] = "Sửa Sản Phẩm";
}

<h2>Sửa Sản Phẩm</h2>

<form asp-action="Edit" enctype="multipart/form-data" method="post">
    <input type="hidden" asp-for="MaSP" />

    <div class="form-group">
        <label asp-for="TenSanPham"></label>
        <input asp-for="TenSanPham" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="GiaCoBan"></label>
        <input asp-for="GiaCoBan" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="ThuongHieu"></label>
        <input asp-for="ThuongHieu" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="LoaiGiay"></label>
        <input asp-for="LoaiGiay" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="MaDM">Danh mục</label>
        <select asp-for="MaDM" class="form-control" asp-items="ViewBag.Categories"></select>
    </div>

    <div class="form-group">
        <label>Ảnh đại diện</label>
        <input asp-for="HinhAnhFile" type="file" class="form-control" />
    </div>

    @if (!string.IsNullOrEmpty(Model.HinhAnhDaiDien))
    {
        <p>Ảnh hiện tại:</p>
        <img src="~/images/@Model.HinhAnhDaiDien" class="img-thumbnail" style="max-width:150px;" />
    }

    <div class="form-group mt-2">
        <label asp-for="MoTa"></label>
        <textarea asp-for="MoTa" class="form-control"></textarea>
    </div>

    <hr />
    <h4>Biến thể sản phẩm</h4>
    <table class="table" id="variantTable">
        <thead>
            <tr>
                <th>Màu</th>
                <th>Size</th>
                <th>Giá</th>
                <th>Số lượng</th>
                <th><button type="button" class="btn btn-success btn-sm" id="addVariant">Thêm</button></th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Variants != null && Model.Variants.Count > 0)
            {
                int i = 0;
                foreach (var v in Model.Variants)
                {
                    <tr>
                        <td><input name="Variants[@i].MauSac" value="@v.MauSac" class="form-control" /></td>
                        <td><input name="Variants[@i].KichCo" value="@v.KichCo" class="form-control" /></td>
                        <td><input name="Variants[@i].Gia" type="number" step="0.01" value="@v.Gia" class="form-control" /></td>
                        <td><input name="Variants[@i].SoLuong" type="number" value="@v.SoLuong" class="form-control" /></td>
                        <td><button type="button" class="btn btn-danger btn-sm removeVariant">Xóa</button></td>
                    </tr>
                    i++;
                }
            }
            else
            {
                <tr>
                    <td><input name="Variants[0].MauSac" class="form-control" /></td>
                    <td><input name="Variants[0].KichCo" class="form-control" /></td>
                    <td><input name="Variants[0].Gia" type="number" step="0.01" class="form-control" /></td>
                    <td><input name="Variants[0].SoLuong" type="number" class="form-control" /></td>
                    <td><button type="button" class="btn btn-danger btn-sm removeVariant">Xóa</button></td>
                </tr>
            }
        </tbody>
    </table>

    <button type="submit" class="btn btn-success mt-2">Cập nhật</button>
    <a asp-action="Index" class="btn btn-secondary mt-2">Hủy</a>
</form>

@section Scripts {
    <script>
        let variantIndex = @Model.Variants?.Count ?? 1;
        document.getElementById("addVariant").addEventListener("click", function() {
            const table = document.getElementById("variantTable").getElementsByTagName('tbody')[0];
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input name="Variants[${variantIndex}].MauSac" class="form-control" /></td>
                <td><input name="Variants[${variantIndex}].KichCo" class="form-control" /></td>
                <td><input name="Variants[${variantIndex}].Gia" type="number" step="0.01" class="form-control" /></td>
                <td><input name="Variants[${variantIndex}].SoLuong" type="number" class="form-control" /></td>
                <td><button type="button" class="btn btn-danger btn-sm removeVariant">Xóa</button></td>
            `;
            table.appendChild(newRow);
            variantIndex++;
        });

        document.getElementById("variantTable").addEventListener("click", function(e) {
            if(e.target && e.target.classList.contains('removeVariant')){
                e.target.closest('tr').remove();
            }
        });
    </script>
}
